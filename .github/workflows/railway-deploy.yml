name: Railway Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  deploy-backend-railway:
    runs-on: ubuntu-latest
    name: Deploy Backend to Railway
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Railway CLI
      run: |
        curl -fsSL https://railway.app/install.sh | sh
        echo "$HOME/.railway/bin" >> $GITHUB_PATH
    
    - name: Deploy to Railway
      run: |
        cd backend
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        railway up --detach
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: Run database migrations
      run: |
        cd backend
        # Wait for deployment to be ready
        sleep 60
        
        railway run php artisan migrate --force
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: Get deployment URL
      id: railway-url
      run: |
        cd backend
        DEPLOYMENT_URL=$(railway status --json | jq -r '.deployments[0].url // empty')
        if [ -z "$DEPLOYMENT_URL" ]; then
          DEPLOYMENT_URL="https://$(railway status --json | jq -r '.service.name // "weeding-backend"')-production.up.railway.app"
        fi
        echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
        echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: Health check
      run: |
        # Wait for app to be fully available
        sleep 30
        
        echo "ðŸ” Performing health check on $DEPLOYMENT_URL"
        
        # Check if the API is responding
        response=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/api/health" || echo "000")
        
        if [ "$response" = "200" ]; then
          echo "âœ… Backend health check passed - API is running!"
        else
          echo "âŒ Backend health check failed - Response code: $response"
          echo "ðŸ” Checking Railway logs..."
          cd backend && railway logs
          exit 1
        fi
    
    - name: Deployment summary
      run: |
        echo "ðŸš‚ Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "=============================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Backend URL:** ${{ env.DEPLOYMENT_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "**API Endpoint:** ${{ env.DEPLOYMENT_URL }}/api" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Health Check:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Features:**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—„ï¸ Automatic PostgreSQL database" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ Zero-downtime deployments" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š Built-in metrics and monitoring" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ Automatic HTTPS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment Variables:**" >> $GITHUB_STEP_SUMMARY
        echo "Configure the following in Railway dashboard:" >> $GITHUB_STEP_SUMMARY
        echo "- \`APP_KEY\` (Laravel application key)" >> $GITHUB_STEP_SUMMARY
        echo "- \`APP_ENV=production\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`APP_DEBUG=false\`" >> $GITHUB_STEP_SUMMARY