name: Railway Deployment

on:
  workflow_call:
  workflow_dispatch:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PRIVATE_DOMAIN: weeding-backend.railway.internal
  RAILWAY_PROJECT_NAME: weeding
  RAILWAY_ENVIRONMENT_NAME: production
  RAILWAY_SERVICE_NAME: weeding-backend
  RAILWAY_PROJECT_ID: aa657bf5-3950-4119-b82e-d42bf3d5607b
  RAILWAY_ENVIRONMENT_ID: d6e59af0-9b1d-4210-a196-a031a32f9139
  RAILWAY_SERVICE_ID: c1031165-c408-45e4-8f1f-c5ce86ad6639  # Kept for reference, using SERVICE_NAME now

jobs:
  deploy-backend-railway:
    runs-on: ubuntu-latest
    name: Deploy Backend to Railway
    outputs:
      deployment-url: ${{ steps.railway-url.outputs.deployment_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Authenticate with GHCR (not needed for direct Railway deployment)
        run: |
          echo "ℹ️ Direct Railway deployment - GHCR authentication not required"

      - name: Deploy to Railway
        run: |
          echo "🚂 Deploying to Railway using Dockerfile.railway..."
          echo "Project: $RAILWAY_PROJECT_NAME"
          echo "Service: $RAILWAY_SERVICE_NAME"
          echo "Project ID: $RAILWAY_PROJECT_ID"
          
          # Link Railway CLI to the project first
          echo "🔗 Linking to Railway project..."
          railway link $RAILWAY_PROJECT_ID
          
          # List available services for debugging
          echo "📋 Available services:"
          railway status --json | jq -r '.services[] | "\(.name): \(.id)"' || echo "Could not list services"
          
          # Deploy using the Railway CLI with the Railway-specific Dockerfile
          # Use service name instead of potentially stale service ID
          echo "🚀 Starting deployment..."
          railway up --detach --service $RAILWAY_SERVICE_NAME
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment to be ready
        run: |
          # Poll for up to 3 minutes for deployment to be live
          for i in {1..36}; do
            STATUS=$(railway status --json | jq -r '.deployments[] | select(.service.name=="'$RAILWAY_SERVICE_NAME'") | .status' | head -n1)
            echo "Current status: $STATUS"
            if [ "$STATUS" = "SUCCESS" ] || [ "$STATUS" = "ACTIVE" ]; then
              echo "Deployment is live!"
              break
            fi
            if [ "$i" -eq 36 ]; then
              echo "Deployment did not become live in time."
              echo "🔍 Fetching deployment logs..."
              railway logs --service $RAILWAY_SERVICE_NAME --tail 50 || echo "Could not fetch logs"
              exit 1
            fi
            sleep 5
          done
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Run database migrations
        run: |
          echo "🔄 Database migrations are handled automatically in Dockerfile.railway startup command"
          echo "Migrations run as part of the container startup process"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Get deployment URL
        id: railway-url
        run: |
          DEPLOYMENT_URL=$(railway status --json | jq -r '.deployments[] | select(.service.name=="'$RAILWAY_SERVICE_NAME'") | .url' | head -n1)
          if [ -z "$DEPLOYMENT_URL" ] || [ "$DEPLOYMENT_URL" = "null" ]; then
            DEPLOYMENT_URL="https://weeding-backend-production.up.railway.app"
          fi
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Railway deployment URL: $DEPLOYMENT_URL"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Health check
        run: |
          echo "🔍 Performing health check on $DEPLOYMENT_URL"
          for i in {1..12}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/api/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "✅ Backend health check passed - API is running!"
              exit 0
            fi
            echo "Waiting for health check to pass (Attempt $i)... Response: $response"
            sleep 10
          done
          echo "❌ Backend health check failed - Response code: $response"
          echo "🔍 Checking Railway logs..."
          railway logs --service $RAILWAY_SERVICE_NAME --tail 50 || echo "Could not fetch logs"
          exit 1
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deployment summary
        run: |
          echo "🚂 Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "=============================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend URL:** ${{ env.DEPLOYMENT_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Endpoint:** ${{ env.DEPLOYMENT_URL }}/api" >> $GITHUB_STEP_SUMMARY
          echo "**Container Deployment:** Railway-optimized Dockerfile.railway" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check:** ✅ Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- 🗄️ Automatic PostgreSQL database" >> $GITHUB_STEP_SUMMARY
          echo "- 🔄 Zero-downtime deployments" >> $GITHUB_STEP_SUMMARY
          echo "- 📊 Built-in metrics and monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- 🔒 Automatic HTTPS" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 Railway-optimized container deployment" >> $GITHUB_STEP_SUMMARY
        env:
          DEPLOYMENT_URL: ${{ env.DEPLOYMENT_URL }}
